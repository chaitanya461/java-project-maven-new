name: Deploy WAR to Tomcat (Slave3)


on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    # Use 'self-hosted' so it runs directly on your slave3 VM
    runs-on: slave

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Build WAR with Maven
      # Ensures a fresh WAR is created
      run: mvn clean package

    - name: Deploy to Tomcat
      # Replace '/opt/tomcat' with your actual Tomcat installation path
      run: |
        echo "Stopping Tomcat..."
        sudo systemctl stop tomcat
        
        echo "Cleaning up old deployment..."
        sudo rm -rf /tomcat/webapps/ROOT/
        sudo rm -f tomcat/webapps/ROOT.war
        
        echo "Moving new WAR to webapps..."
        # Renaming to ROOT.war deploys the app at the '/' path
        sudo cp target/*.war tomcat/webapps/ROOT.war
        
        echo "Starting Tomcat..."
        sudo systemctl start tomcat
